// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==================== MODELS ====================

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  password          String
  name              String
  phone             String?
  role              String    @default("CLIENTE") // CLIENTE ou ADMIN
  isActive          Boolean   @default(true)

  // Recuperacao de senha
  resetToken        String?   @unique
  resetTokenExpiry  DateTime?

  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relacoes
  orders            Order[]
  cart              Cart?

  @@map("users")
}

model Category {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  imageUrl    String?
  isActive    Boolean   @default(true)
  sortOrder   Int       @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relacoes
  products    Product[]

  @@map("categories")
}

model Product {
  id           String   @id @default(uuid())
  name         String
  description  String?
  price        Float
  imageUrl     String?
  isAvailable  Boolean  @default(true)

  // Categoria
  categoryId   String
  category     Category @relation(fields: [categoryId], references: [id])

  // Controle de estoque (opcional)
  stockQuantity Int?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relacoes
  cartItems    CartItem[]
  orderItems   OrderItem[]

  @@map("products")
}

model Cart {
  id        String     @id @default(uuid())

  // Usuario dono do carrinho
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relacoes
  items     CartItem[]

  @@map("carts")
}

model CartItem {
  id        String   @id @default(uuid())
  quantity  Int      @default(1)
  notes     String?

  // Carrinho
  cartId    String
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)

  // Produto
  productId String
  product   Product  @relation(fields: [productId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Impede duplicacao de produto no mesmo carrinho
  @@unique([cartId, productId])
  @@map("cart_items")
}

model Order {
  id           String   @id @default(uuid())
  orderNumber  Int      @unique
  status       String   @default("PENDENTE") // PENDENTE, EM_PREPARO, PRONTO, ENTREGUE, CANCELADO
  totalAmount  Float
  notes        String?

  // Cliente
  userId       String
  user         User     @relation(fields: [userId], references: [id])

  // Timestamps de status
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  preparedAt   DateTime?
  readyAt      DateTime?
  deliveredAt  DateTime?
  cancelledAt  DateTime?

  // Relacoes
  items        OrderItem[]
  statusHistory OrderStatusHistory[]

  @@map("orders")
}

model OrderItem {
  id          String   @id @default(uuid())
  quantity    Int
  unitPrice   Float
  totalPrice  Float
  notes       String?

  // Pedido
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Produto (snapshot do nome para historico)
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  productName String

  @@map("order_items")
}

// Historico de mudancas de status do pedido
model OrderStatusHistory {
  id          String   @id @default(uuid())
  status      String   // PENDENTE, EM_PREPARO, PRONTO, ENTREGUE, CANCELADO
  changedAt   DateTime @default(now())
  changedBy   String?
  notes       String?

  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_status_history")
}

// Contador para numero sequencial de pedidos
model Counter {
  id    String @id @default("order_counter")
  value Int    @default(0)

  @@map("counters")
}
